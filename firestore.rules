rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if the user owns this resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to validate timestamp
    function isValidTimestamp(field) {
      return field is int && field > 0;
    }
    
    // Users collection
    // - Users can read their own profile
    // - Users can read other profiles (for leaderboard, challenge participants)
    // - Only the owner or server can update their profile
    // - Creation is handled by the server during signup
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow update: if isOwner(userId) && 
        // Users can only update these fields
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['avatar', 'username']);
      // Creation and deletion only via Admin SDK (server-side)
      allow create, delete: if false;
    }
    
    // Exercise logs collection
    // - Users can only read and write their own logs
    // - Logs are created by the server, but we allow read access
    match /exercise_logs/{logId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Creation is handled by server to ensure XP calculations are accurate
      allow create, update, delete: if false;
    }
    
    // Challenges collection
    // - Public challenges can be read by any authenticated user
    // - Private challenges can only be read by participants
    // - Only the server can create/update challenges (to ensure data integrity)
    match /challenges/{challengeId} {
      allow read: if isAuthenticated() && (
        resource.data.isPublic == true ||
        request.auth.uid in resource.data.participantIds
      );
      // All writes handled by server to ensure data integrity
      allow create, update, delete: if false;
    }
    
    // Challenge invites collection
    // - Users can read invites sent to them
    // - Users can read invites they sent
    // - All writes handled by server
    match /challengeInvites/{inviteId} {
      allow read: if isAuthenticated() && (
        resource.data.invitedUserId == request.auth.uid ||
        resource.data.invitedBy == request.auth.uid
      );
      // All writes handled by server to ensure proper validation
      allow create, update, delete: if false;
    }
    
    // Invite codes collection
    // - Users can read their own invite codes (to share with others)
    // - All writes handled by server (code generation, marking as used)
    match /inviteCodes/{codeId} {
      allow read: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      // All writes handled by server for security
      allow create, update, delete: if false;
    }

    // Follows collection
    // - Users can read follows where they're the follower or following
    // - All writes handled by server to ensure data integrity
    match /follows/{followId} {
      allow read: if isAuthenticated() && (
        resource.data.followerId == request.auth.uid ||
        resource.data.followingId == request.auth.uid
      );
      // All writes handled by server for security
      allow create, update, delete: if false;
    }

    // Catch-all: deny access to any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
